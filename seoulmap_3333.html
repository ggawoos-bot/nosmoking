<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울시 금연구역 지도 🚭</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" xintegrity="sha512-1yH5t4b4R+3x5n7/6t9xRj2+0r0z0e9y0g7D5t1L0s1b7A4q2z0x1D2w2Q2v0s0b9C2q5s0t3/4x7C2r0o5s0f1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: "Inter", sans-serif; }
        .map-container { width: 100%; height: 80vh; border-radius: 0.5rem; overflow: hidden; }
        /* Custom styling for Kakao Maps InfoWindow content */
        .info-window-content { padding: 8px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 150px; }
        .info-window-content h3 { font-weight: bold; font-size: 1.125rem; margin-bottom: 4px; color: #1f2937; }
        .info-window-content p { font-size: 0.875rem; color: #374151; margin-bottom: 2px; }
        .info-window-content .text-xs { font-size: 0.75rem; color: #6b7280; margin-top: 4px;}
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 font-inter flex flex-col lg:flex-row">
    <!-- Left Sidebar for Search and List -->
    <aside class="w-full lg:w-1/3 p-4 bg-white rounded-lg shadow-xl mb-4 lg:mb-0 lg:mr-4 flex flex-col">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">금연구역 검색</h2>
        
        <!-- Search Input -->
        <div class="mb-4">
            <input
                type="text"
                id="searchTerm"
                placeholder="주소, 장소명 등으로 검색..."
                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700"
                onkeyup="handleSearchChange()"
            />
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mb-4 space-x-2">
            <button
                id="myLocationBtn"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
            >
                <i class="fas fa-location-arrow mr-2"></i> 내 위치
            </button>
            <button
                id="listTabBtn"
                class="flex-1 px-4 py-2 rounded-md transition-colors duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-blue-500 text-white"
            >
                <i class="fas fa-list mr-2"></i> 목록
            </button>
            <button
                id="mapTabBtn"
                class="flex-1 px-4 py-2 rounded-md transition-colors duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-gray-200 text-gray-700 hover:bg-gray-300"
            >
                <i class="fas fa-map-marker-alt mr-2"></i> 지도
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center text-gray-600 mt-4 hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i> 데이터 로딩 중...
        </div>

        <!-- API Error Message -->
        <div id="apiErrorMessage" class="text-center text-red-600 mt-4 p-2 bg-red-100 rounded-md hidden">
            <i class="fas fa-exclamation-triangle mr-2"></i> 지도 또는 금연구역 데이터를 불러오는 데 실패했습니다.
        </div>

        <!-- No-Smoking Area List -->
        <div id="noSmokingAreaList" class="flex-1 overflow-y-auto border border-gray-200 rounded-md p-2 bg-gray-50">
            <!-- List items will be dynamically inserted here -->
        </div>
      </aside>

    <!-- Main Content Area for Map -->
    <div class="flex-1 flex flex-col">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">
                서울시 금연구역 지도 🚭
            </h1>
            <p class="text-lg text-gray-600">
                서울시의 주요 금연구역 위치를 확인하세요.
            </p>
        </header>

        <main class="relative flex-1 rounded-lg shadow-xl overflow-hidden">
            <div
                id="map"
                class="map-container bg-gray-200 flex items-center justify-center text-gray-500 text-lg"
            >
                <!-- Map will be initialized here by Kakao Maps API -->
                <span id="mapLoadingMessage">지도 로딩 중...</span>
            </div>
             <div id="mapApiErrorMessage" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-lg p-4 hidden">
                카카오 지도 또는 금연구역 API 데이터를 불러올 수 없습니다.
            </div>
        </main>

        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>&copy; 2025 서울시 금연구역 지도. 모든 권리 보유.</p>
            <p>데이터는 서울시 공공데이터포털에서 제공됩니다.</p>
        </footer>
    </div>

    <!-- Kakao Maps API Script -->
    <script>
        const KAKAO_APP_KEY = '129768458014c00b9a8c5353802e9a79'; // Your Kakao Maps API Key
        const SEOUL_API_KEY = "66734e706b67617736344b52704b67"; // Your Seoul Open API Key
        const SEOUL_API_URL = `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/xml/tbPrhSmkArea/1/5/`; // Fetch only 5 records

        let kakaoMap = null;
        let markers = [];
        let infoWindow = null;
        let noSmokingAreas = [];
        let filteredAreas = [];
        let selectedArea = null;
        let mapLoaded = false;
        let loading = true;
        let apiError = false;

        // Directly get the map container element
        const mapContainer = document.getElementById('map'); 
        const loadingIndicator = document.getElementById('loadingIndicator');
        const apiErrorMessage = document.getElementById('apiErrorMessage');
        const mapApiErrorMessage = document.getElementById('mapApiErrorMessage');
        const noSmokingAreaList = document.getElementById('noSmokingAreaList');
        const searchTermInput = document.getElementById('searchTerm');
        const myLocationBtn = document.getElementById('myLocationBtn');
        const listTabBtn = document.getElementById('listTabBtn');
        const mapTabBtn = document.getElementById('mapTabBtn');
        const mapLoadingMessage = document.getElementById('mapLoadingMessage');


        // Function to update UI based on loading/error states
        function updateUI() {
            if (loading) {
                loadingIndicator.classList.remove('hidden');
                apiErrorMessage.classList.add('hidden');
                mapApiErrorMessage.classList.add('hidden');
                mapLoadingMessage.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
                mapLoadingMessage.classList.add('hidden');
                if (apiError) {
                    apiErrorMessage.classList.remove('hidden');
                    mapApiErrorMessage.classList.remove('hidden');
                    if (mapContainer) mapContainer.innerHTML = ''; // Clear map if API failed
                } else {
                    apiErrorMessage.classList.add('hidden');
                    mapApiErrorMessage.classList.add('hidden');
                }
            }
        }

        // Initialize Kakao Map
        function initMap() {
            if (mapContainer) { // Ensure map container exists
                 const options = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780), // Default Seoul center
                    level: 7
                };
                kakaoMap = new kakao.maps.Map(mapContainer, options); // Use mapContainer directly
                infoWindow = new kakao.maps.InfoWindow({ zIndex: 1 });
                mapLoaded = true;
                updateMapMarkers();
                updateUI();
            } else {
                console.error("Map container element not found.");
                apiError = true;
                loading = false;
                updateUI();
            }
        }


        // Dynamically load the Kakao Maps API script
        function loadKakaoMapScript() {
            if (window.kakao && window.kakao.maps) {
                mapLoaded = true;
                initMap(); // Initialize map if script is already loaded
                return;
            }

            const script = document.createElement('script');
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_APP_KEY}`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            script.onload = () => {
                kakao.maps.load(function() { // Use kakao.maps.load for proper initialization
                    mapLoaded = true;
                    initMap(); // Call initMap after Kakao Maps API is fully loaded
                });
            };

            script.onerror = () => {
                console.error("Kakao Maps API script failed to load.");
                apiError = true;
                loading = false;
                updateUI();
            };
        }

        // Fetch no-smoking area data from the Seoul Open API
        async function fetchNoSmokingData() {
            loading = true;
            apiError = false;
            updateUI();

            try {
                const response = await fetch(SEOUL_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "application/xml");
                
                const items = xmlDoc.getElementsByTagName('row');
                const parsedAreas = Array.from(items).map((item, index) => {
                    const latitude = parseFloat(item.getElementsByTagName('Y_DNTS')[0]?.textContent || '0');
                    const longitude = parseFloat(item.getElementsByTagName('X_CNTS')[0]?.textContent || '0');
                    const name = item.getElementsByTagName('SM_NM')[0]?.textContent || `금연구역 ${1 + index}`;
                    const address = item.getElementsByTagName('SM_ADRES1')[0]?.textContent || '주소 정보 없음';
                    const description = item.getElementsByTagName('SM_CN')[0]?.textContent || '설명 없음';
                    const type = item.getElementsByTagName('SM_WDR_NM')[0]?.textContent || '유형 없음';

                    return {
                        id: `api_${1 + index}`,
                        name: name,
                        lat: latitude,
                        lng: longitude,
                        description: description,
                        address: address,
                        type: type,
                    };
                }).filter(area => area.lat !== 0 && area.lng !== 0);

                if (parsedAreas.length === 0) {
                    console.warn("API fetched no valid no-smoking areas. Please check the API response or key.");
                    apiError = true;
                } else {
                    noSmokingAreas = parsedAreas;
                    filteredAreas = parsedAreas;
                }
            } catch (error) {
                console.error("Error fetching no-smoking area data:", error);
                apiError = true;
            } finally {
                loading = false;
                updateUI();
                updateMapMarkers();
                updateAreaList();
            }
        }

        // Update markers on the map
        function updateMapMarkers() {
            if (!kakaoMap || !mapLoaded) return;

            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const bounds = new kakao.maps.LatLngBounds();

            filteredAreas.forEach(area => {
                const position = new kakao.maps.LatLng(area.lat, area.lng);
                const marker = new kakao.maps.Marker({
                    map: kakaoMap,
                    position: position,
                    title: area.name,
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    displayInfoWindow(area, marker);
                });
                markers.push(marker);
                bounds.extend(position);
            });

            if (!bounds.isEmpty()) {
                kakaoMap.setBounds(bounds);
            }
        }

        // Display InfoWindow
        function displayInfoWindow(area, marker) {
            const content = `<div class="info-window-content">
                                <h3>${area.name}</h3>
                                <p>${area.description}</p>
                                <p class="text-xs">주소: ${area.address}</p>
                                <p class="text-xs">유형: ${area.type}</p>
                            </div>`;
            infoWindow.setContent(content);
            infoWindow.open(kakaoMap, marker);
            kakaoMap.panTo(marker.getPosition());
        }

        // Update the list of no-smoking areas
        function updateAreaList() {
            noSmokingAreaList.innerHTML = ''; // Clear current list

            if (filteredAreas.length === 0 && !apiError) {
                noSmokingAreaList.innerHTML = '<p class="text-center text-gray-500 mt-4">검색 결과가 없습니다.</p>';
                return;
            } else if (apiError) {
                 noSmokingAreaList.innerHTML = '<p class="text-center text-gray-500 mt-4">데이터를 불러올 수 없습니다.</p>';
                 return;
            }

            const ul = document.createElement('ul');
            filteredAreas.forEach(area => {
                const li = document.createElement('li');
                li.className = `p-3 mb-2 rounded-md cursor-pointer transition-colors duration-150 ease-in-out bg-white hover:bg-gray-100 border border-gray-200 shadow-sm`;
                if (selectedArea && selectedArea.id === area.id) {
                    li.classList.add('bg-blue-100', 'border-blue-400', 'border-2');
                }
                li.innerHTML = `
                    <h3 class="font-semibold text-gray-800 text-base">${area.name}</h3>
                    <p class="text-sm text-gray-600 truncate">${area.address}</p>
                    <p class="text-xs text-gray-500">유형: ${area.type}</p>
                `;
                li.onclick = () => handleListItemClick(area);
                ul.appendChild(li);
            });
            noSmokingAreaList.appendChild(ul);
        }

        // Event handlers
        function handleSearchChange() {
            const searchTerm = searchTermInput.value.toLowerCase();
            filteredAreas = noSmokingAreas.filter(area =>
                area.name.toLowerCase().includes(searchTerm) ||
                area.address.toLowerCase().includes(searchTerm) ||
                area.description.toLowerCase().includes(searchTerm) ||
                area.type.toLowerCase().includes(searchTerm)
            );
            selectedArea = null; // Clear selected area on search
            if (infoWindow) infoWindow.close(); // Close info window
            updateMapMarkers();
            updateAreaList();
        }

        function handleListItemClick(area) {
            selectedArea = area;
            if (kakaoMap) {
                const position = new kakao.maps.LatLng(area.lat, area.lng);
                kakaoMap.panTo(position);
                kakaoMap.setLevel(3);
                
                // Find corresponding marker to open info window
                const marker = markers.find(m => 
                    m.getPosition().getLat() === area.lat && m.getPosition().getLng() === area.lng
                );
                if (marker) {
                    displayInfoWindow(area, marker);
                }
            }
            updateAreaList(); // Re-render list to highlight selected item
        }

        function handleMyLocation() {
            if (navigator.geolocation && kakaoMap) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        kakaoMap.setCenter(pos);
                        kakaoMap.setLevel(3);
                        // Optionally add a marker for current location
                    },
                    () => {
                        alert('현재 위치를 가져올 수 없습니다. 위치 권한을 확인해주세요.');
                    }
                );
            } else {
                alert('이 브라우저는 지오로케이션을 지원하지 않습니다.');
            }
        }

        // Initial setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure mapContainer is initialized before initMap is called indirectly
            // It's already done globally now, but good to ensure if logic changes
            loadKakaoMapScript(); // Load Kakao Map API script
            fetchNoSmokingData(); // Fetch no-smoking area data
            
            // Event Listeners for buttons
            myLocationBtn.addEventListener('click', handleMyLocation);
            listTabBtn.addEventListener('click', () => {
                listTabBtn.classList.add('bg-blue-500', 'text-white');
                listTabBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                mapTabBtn.classList.remove('bg-blue-500', 'text-white');
                mapTabBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                // Additional logic to show/hide map/list views if needed, currently sidebar is always visible
            });
            mapTabBtn.addEventListener('click', () => {
                mapTabBtn.classList.add('bg-blue-500', 'text-white');
                mapTabBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                listTabBtn.classList.remove('bg-blue-500', 'text-white');
                listTabBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                // Additional logic to show/hide map/list views if needed
            });
        });
    </script>
</body>
</html>
